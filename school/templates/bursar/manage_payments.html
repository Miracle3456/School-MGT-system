{% extends 'base.html' %}
{% block title %}Manage Payments{% endblock %}
{% block content %}
        <nav style="margin-bottom:12px">
            <a class="btn btn-outline-primary" href="{% url 'bursar_dashboard' %}">Home</a>
            <a class="btn" href="javascript:history.back()">Back</a>
        </nav>

                <h1 style="margin-top:0">Record a Payment</h1>
                {% if prefill_student %}
                    <div class="card" style="margin-bottom:12px">
                        <h3 style="margin-top:0">Student</h3>
                        <p><strong>{{ prefill_student.user.get_full_name }}</strong> ({{ prefill_student.admission_number }}) — Class: {{ prefill_student.student_class.name }}</p>
                        {% if prefill_summary %}
                            <p>Total Due: {{ prefill_summary.expected }} | Paid: {{ prefill_summary.paid }} | Balance: {{ prefill_summary.balance }}</p>
                        {% endif %}
                        <p><a class="btn" href="{% url 'student_fee_detail' student_id=prefill_student.id %}">View Fee Ledger</a></p>
                    </div>
                {% endif %}
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="processed_by" value="{{ request.user.id }}" />
        <label>Student
            <select name="student_id" id="student_select" required onchange="loadStudentBalance()">
                <option value="">-- Select student --</option>
                {% for s in students %}
                                        <option value="{{ s.id }}" {% if prefill_student_id and prefill_student_id == s.id %}selected{% endif %} data-admission="{{ s.admission_number }}" data-name="{{ s.user.get_full_name }}" data-class="{{ s.student_class.name }}">{{ s.admission_number }} - {{ s.user.get_full_name }}</option>
                {% endfor %}
            </select>
        </label>
        <div id="balance_display" class="card" style="margin:12px 0;padding:12px;display:none">
            <h4 style="margin:0 0 8px 0">Outstanding Balance</h4>
            <p id="balance_info" style="margin:0"></p>
        </div>
        <label>Amount
            <input type="number" name="amount" step="0.01" required />
        </label>
                <fieldset style="border:none;padding:0;margin:8px 0">
                        <label style="display:block;margin-bottom:6px">Payment Method</label>
                        <style>
                            .pm-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
                            .pm-card{display:flex;align-items:center;gap:10px;border:1px solid #334155;border-radius:12px;padding:12px;background:#0f172a;color:#e5e7eb}
                            .pm-card svg{width:22px;height:22px;flex:0 0 22px}
                            .pm-card span{color:#e5e7eb;font-weight:500}
                            .pm-card:hover{border-color:#60a5fa;background:#0b1324}
                        </style>
                        <div class="pm-grid">
                                {% for key,label in payment_methods %}
                                    <label class="pm-card">
                                        <input type="radio" name="payment_method" value="{{ key }}" required />
                                        {% if key == 'cash' %}
                                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/><path d="M3 9c2 0 3-2 3-2m15 2c-2 0-3-2-3-2" stroke="currentColor" stroke-width="2"/></svg>
                                        {% elif key == 'bank' %}
                                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 8l9-5 9 5v2H3V8Z" stroke="currentColor" stroke-width="2"/><path d="M5 10v8m4-8v8m4-8v8m4-8v8M3 18h18" stroke="currentColor" stroke-width="2"/></svg>
                                        {% elif key == 'mtn' %}
                                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="16" rx="3" stroke="currentColor" stroke-width="2"/><path d="M7 9h10M7 12h7M7 15h6" stroke="currentColor" stroke-width="2"/></svg>
                                        {% elif key == 'airtel' %}
                                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="3" width="16" height="18" rx="3" stroke="currentColor" stroke-width="2"/><path d="M8 7h8M8 11h6M8 15h5" stroke="currentColor" stroke-width="2"/></svg>
                                        {% elif key == 'momo_pay' %}
                                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/><path d="M8 9h8M10 13h6" stroke="currentColor" stroke-width="2"/><rect x="6" y="8" width="4" height="4" stroke="currentColor" stroke-width="2"/></svg>
                                        {% else %}
                                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/></svg>
                                        {% endif %}
                                        <span>{{ label }}</span>
                                    </label>
                                {% endfor %}
                        </div>
                </fieldset>
        <label>Transaction Reference
            <input type="text" name="transaction_reference" />
        </label>
        <label>Notes
            <textarea name="notes" rows="2"></textarea>
        </label>
        <button type="submit" class="btn btn-success">Record Payment</button>
    </form>

        <hr />
        <h2>Students Fee Summary (Active Term: {{ active_term }})</h2>
        <div class="card" style="margin:16px 0;padding:12px">
            <h3 style="margin-top:0">Unpaid Reports</h3>
            <form onsubmit="return false" class="row" style="gap:12px;align-items:flex-end">
                <div class="col" style="min-width:200px">
                    <label>Class
                        <select id="unpaid_class_select">
                            <option value="">-- Select class --</option>
                            {% for c in classes %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>
                <div class="col">
                    <button type="button" class="btn" onclick="var c=document.getElementById('unpaid_class_select').value; if(!c){alert('Select a class');return;} var t='{{ active_term.id }}'; window.location = '{% url 'bursar_unpaid_report' class_id=0 term_id=0 %}'.replace('/class/0/term/0','/class/'+c+'/term/'+t);">Download CSV</button>
                </div>
                <div class="col">
                    <button type="button" class="btn btn-outline-primary" onclick="var c=document.getElementById('unpaid_class_select').value; if(!c){alert('Select a class');return;} var t='{{ active_term.id }}'; window.location = '{% url 'bursar_unpaid_report_pdf' class_id=0 term_id=0 %}'.replace('/class/0/term/0/pdf','/class/'+c+'/term/'+t+'/pdf');">Download PDF</button>
                </div>
            </form>
        </div>
    <table>
        <thead><tr><th>Admission</th><th>Name</th><th>Details</th></tr></thead>
        <tbody>
            {% for s in students %}
                <tr>
                    <td>{{ s.admission_number }}</td>
                    <td>{{ s.user.get_full_name }}</td>
                    <td><a href="{% url 'student_fee_detail' student_id=s.id %}">View</a></td>
                </tr>
            {% empty %}
                <tr><td colspan="3">No students available.</td></tr>
            {% endfor %}
        </tbody>
    </table>

<script>
const feeStatusData = {{ fee_status_json|safe }};

function loadStudentBalance() {
  const select = document.getElementById('student_select');
  const display = document.getElementById('balance_display');
  const info = document.getElementById('balance_info');
  const studentId = select.value;
  
  if (!studentId) {
    display.style.display = 'none';
    return;
  }
  
  const option = select.options[select.selectedIndex];
  const name = option.getAttribute('data-name');
  const admission = option.getAttribute('data-admission');
  const className = option.getAttribute('data-class');
  const data = feeStatusData[studentId] || { total_fees: 0, total_paid: 0, balance: 0 };
  
  info.innerHTML = `
    <strong>${name}</strong> (${admission}) — Class: ${className}<br/>
    <span style="color:#60a5fa">Total Due: ${data.total_fees.toFixed(2)}</span> | 
    <span style="color:#34d399">Paid: ${data.total_paid.toFixed(2)}</span> | 
    <span style="color:${data.balance > 0 ? '#fbbf24' : '#34d399'}">Balance: ${data.balance.toFixed(2)}</span>
  `;
  display.style.display = 'block';
}

// Auto-load if student is prefilled
window.addEventListener('DOMContentLoaded', function() {
  const select = document.getElementById('student_select');
  if (select.value) {
    loadStudentBalance();
  }
});
</script>
{% endblock %}
